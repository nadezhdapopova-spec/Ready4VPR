name: Django CI

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run flake8
        run: flake8 .

  test:
    needs: lint
    runs-on: ubuntu-latest

    env:
      SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}

    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        mkdir -p ./static

    - name: Run tests
      run: python manage.py test -v 2 --failfast

  build:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        run: echo ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }} | docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin

      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/ready4vpr:${{ github.sha }} .

      - name: Push Docker image in Docker Hub
        run: docker push ${{ secrets.DOCKER_HUB_USERNAME }}/ready4vpr:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << EOF
          mkdir -p /home/${{ secrets.SSH_USER }}/ready4vpr
          touch /home/${{ secrets.SSH_USER }}/ready4vpr/.env  
          echo "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" > /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "DEBUG=False" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "DB_NAME=ready_four_vpr" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "DB_USER=postgres" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "DB_HOST=db" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "DB_PORT=5432" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "REDIS_LOCATION=redis://redis:6379/1" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "CELERY_BROKER_URL=redis://redis:6379/2" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "CELERY_RESULT_BACKEND=redis://redis:6379/3" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "EMAIL_HOST=smtp.yandex.ru" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "EMAIL_PORT=465" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "EMAIL_USE_TLS=False" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "EMAIL_USE_SSL=True" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "STRIPE_API_KEY=${{ secrets.STRIPE_API_KEY }}" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          echo "DOCKER_HUB_TAG=${{ github.sha }}" >> /home/${{ secrets.SSH_USER }}/ready4vpr/.env
          EOF          
          scp docker-compose.yaml ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:/home/${{ secrets.SSH_USER }}/ready4vpr/docker-compose.yaml 
